"use strict";var ChatWidget=(()=>{var ie=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var Qe=Object.prototype.hasOwnProperty;var Xe=(i,e)=>{for(var t in e)ie(i,t,{get:e[t],enumerable:!0})},Ke=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ve(e))!Qe.call(i,s)&&s!==t&&ie(i,s,{get:()=>e[s],enumerable:!(n=Ge(e,s))||n.enumerable});return i};var Ye=i=>Ke(ie({},"__esModule",{value:!0}),i);var Zt={};Xe(Zt,{ChatWidget:()=>P,mergeConfig:()=>B,validateConfig:()=>D});var Je={position:"bottom-right",avatarSize:60,primaryColor:"#0066cc",chatWidth:400,chatHeight:600,headerTitle:"Chat with Us",welcomeMessage:"Hello! How can I help you today?",placeholder:"Type your message...",openOnLoad:!1,persistSession:!0,sessionStorageKey:"chat-widget-session",pushContent:!0,includePageContext:!1,pageContextSelector:null,enableMarkdown:!0,syntaxHighlighting:!0,syntaxTheme:"github-dark",authToken:null,authHeader:"Authorization"};function B(i){return{...Je,...i}}function D(i){let e=[];if(!i.agentEndpoint)e.push("agentEndpoint is required");else try{new URL(i.agentEndpoint)}catch{e.push("agentEndpoint must be a valid URL")}return i.avatarSize!==void 0&&(i.avatarSize<30||i.avatarSize>120)&&e.push("avatarSize must be between 30 and 120"),i.chatWidth!==void 0&&(i.chatWidth<280||i.chatWidth>800)&&e.push("chatWidth must be between 280 and 800"),i.chatHeight!==void 0&&i.chatHeight!=="full"&&typeof i.chatHeight=="number"&&(i.chatHeight<300||i.chatHeight>1200)&&e.push('chatHeight must be between 300 and 1200, or "full"'),i.position!==void 0&&!["bottom-right","bottom-left"].includes(i.position)&&e.push('position must be "bottom-right" or "bottom-left"'),i.syntaxTheme!==void 0&&!["github-dark","github-light","monokai"].includes(i.syntaxTheme)&&e.push('syntaxTheme must be "github-dark", "github-light", or "monokai"'),e}var O=class{constructor(e){this.abortController=null;this.config=e}async streamMessage(e,t,n,s,r,a){this.abortController=new AbortController;let o=this.buildStreamUrl(),c=this.buildHeaders(),l={message:e,conversationId:t,metadata:a?{pageContext:a}:{}};try{let h=await fetch(o,{method:"POST",headers:c,body:JSON.stringify(l),signal:this.abortController.signal});if(!h.ok){let m=await h.text();throw new Error(`HTTP ${h.status}: ${m||h.statusText}`)}let d=h.body?.getReader();if(!d)throw new Error("Response body is not readable");let p=new TextDecoder,f="";for(;;){let{done:m,value:b}=await d.read();if(m){f.trim()&&this.processSSELines(f,n);break}f+=p.decode(b,{stream:!0});let M=f.split(`
`);f=M.pop()||"";let $=M.join(`
`);this.processSSELines($,n)}s()}catch(h){if(h.name==="AbortError")return;r(h)}finally{this.abortController=null}}processSSELines(e,t){let n=e.split(`
`);for(let s of n){let r=s.trim();if(!(!r||r.startsWith(":"))&&r.startsWith("data: ")){let a=r.slice(6);if(a==="[DONE]")continue;try{let o=JSON.parse(a);t(o)}catch(o){console.warn("[ChatWidget] Failed to parse SSE event:",a,o)}}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=null)}isStreaming(){return this.abortController!==null}buildStreamUrl(){let e=this.config.agentEndpoint;return e.endsWith("/stream")?e:e.endsWith("/")?`${e}stream`:`${e}/stream`}buildHeaders(){let e={"Content-Type":"application/json",Accept:"text/event-stream"};return this.config.authToken&&(this.config.authHeader==="Authorization"?e.Authorization=`Bearer ${this.config.authToken}`:e[this.config.authHeader]=this.config.authToken),e}async sendMessage(e,t){let n=this.config.agentEndpoint.replace(/\/stream$/,"/chat"),s=this.buildHeaders();s.Accept="application/json";let a=await fetch(n,{method:"POST",headers:s,body:JSON.stringify({message:e,conversationId:t,metadata:{}})});if(!a.ok){let l=await a.text();throw new Error(`HTTP ${a.status}: ${l||a.statusText}`)}let o=await a.json();return[{type:"start"},{type:"text",content:o.data?.text||o.text||""},{type:"finish"}]}};function ae(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var T=ae();function Me(i){T=i}var z={exec:()=>null};function u(i,e=""){let t=typeof i=="string"?i:i.source,n={replace:(s,r)=>{let a=typeof r=="string"?r:r.source;return a=a.replace(x.caret,"$1"),t=t.replace(s,a),n},getRegex:()=>new RegExp(t,e)};return n}var x={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:i=>new RegExp(`^( {0,3}${i})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}#`),htmlBeginRegex:i=>new RegExp(`^ {0,${Math.min(3,i-1)}}<(?:[a-z].*>|!--)`,"i")},et=/^(?:[ \t]*(?:\n|$))+/,tt=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,it=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,I=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,nt=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,oe=/(?:[*+-]|\d{1,9}[.)])/,$e=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Le=u($e).replace(/bull/g,oe).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),st=u($e).replace(/bull/g,oe).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),le=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,rt=/^[^\n]+/,ce=/(?!\s*\])(?:\\.|[^\[\]\\])+/,at=u(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",ce).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ot=u(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,oe).getRegex(),U="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",he=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,lt=u("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",he).replace("tag",U).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Ae=u(le).replace("hr",I).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",U).getRegex(),ct=u(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Ae).getRegex(),de={blockquote:ct,code:tt,def:at,fences:it,heading:nt,hr:I,html:lt,lheading:Le,list:ot,newline:et,paragraph:Ae,table:z,text:rt},Se=u("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",I).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",U).getRegex(),ht={...de,lheading:st,table:Se,paragraph:u(le).replace("hr",I).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Se).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",U).getRegex()},dt={...de,html:u(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",he).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:z,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:u(le).replace("hr",I).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Le).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},pt=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,gt=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Re=/^( {2,}|\\)\n(?!\s*$)/,ut=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,Z=/[\p{P}\p{S}]/u,pe=/[\s\p{P}\p{S}]/u,ze=/[^\s\p{P}\p{S}]/u,mt=u(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,pe).getRegex(),Ie=/(?!~)[\p{P}\p{S}]/u,ft=/(?!~)[\s\p{P}\p{S}]/u,wt=/(?:[^\s\p{P}\p{S}]|~)/u,xt=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,He=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,bt=u(He,"u").replace(/punct/g,Z).getRegex(),vt=u(He,"u").replace(/punct/g,Ie).getRegex(),Pe="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",kt=u(Pe,"gu").replace(/notPunctSpace/g,ze).replace(/punctSpace/g,pe).replace(/punct/g,Z).getRegex(),yt=u(Pe,"gu").replace(/notPunctSpace/g,wt).replace(/punctSpace/g,ft).replace(/punct/g,Ie).getRegex(),St=u("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,ze).replace(/punctSpace/g,pe).replace(/punct/g,Z).getRegex(),Ct=u(/\\(punct)/,"gu").replace(/punct/g,Z).getRegex(),Tt=u(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),_t=u(he).replace("(?:-->|$)","-->").getRegex(),Et=u("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",_t).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),W=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,Mt=u(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",W).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Be=u(/^!?\[(label)\]\[(ref)\]/).replace("label",W).replace("ref",ce).getRegex(),De=u(/^!?\[(ref)\](?:\[\])?/).replace("ref",ce).getRegex(),$t=u("reflink|nolink(?!\\()","g").replace("reflink",Be).replace("nolink",De).getRegex(),ge={_backpedal:z,anyPunctuation:Ct,autolink:Tt,blockSkip:xt,br:Re,code:gt,del:z,emStrongLDelim:bt,emStrongRDelimAst:kt,emStrongRDelimUnd:St,escape:pt,link:Mt,nolink:De,punctuation:mt,reflink:Be,reflinkSearch:$t,tag:Et,text:ut,url:z},Lt={...ge,link:u(/^!?\[(label)\]\((.*?)\)/).replace("label",W).getRegex(),reflink:u(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",W).getRegex()},ne={...ge,emStrongRDelimAst:yt,emStrongLDelim:vt,url:u(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},At={...ne,br:u(Re).replace("{2,}","*").getRegex(),text:u(ne.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},N={normal:de,gfm:ht,pedantic:dt},A={normal:ge,gfm:ne,breaks:At,pedantic:Lt},Rt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Ce=i=>Rt[i];function v(i,e){if(e){if(x.escapeTest.test(i))return i.replace(x.escapeReplace,Ce)}else if(x.escapeTestNoEncode.test(i))return i.replace(x.escapeReplaceNoEncode,Ce);return i}function Te(i){try{i=encodeURI(i).replace(x.percentDecode,"%")}catch{return null}return i}function _e(i,e){let t=i.replace(x.findPipe,(r,a,o)=>{let c=!1,l=a;for(;--l>=0&&o[l]==="\\";)c=!c;return c?"|":" |"}),n=t.split(x.splitPipe),s=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(x.slashPipe,"|");return n}function R(i,e,t){let n=i.length;if(n===0)return"";let s=0;for(;s<n;){let r=i.charAt(n-s-1);if(r===e&&!t)s++;else if(r!==e&&t)s++;else break}return i.slice(0,n-s)}function zt(i,e){if(i.indexOf(e[1])===-1)return-1;let t=0;for(let n=0;n<i.length;n++)if(i[n]==="\\")n++;else if(i[n]===e[0])t++;else if(i[n]===e[1]&&(t--,t<0))return n;return t>0?-2:-1}function Ee(i,e,t,n,s){let r=e.href,a=e.title||null,o=i[1].replace(s.other.outputLinkReplace,"$1");n.state.inLink=!0;let c={type:i[0].charAt(0)==="!"?"image":"link",raw:t,href:r,title:a,text:o,tokens:n.inlineTokens(o)};return n.state.inLink=!1,c}function It(i,e,t){let n=i.match(t.other.indentCodeCompensation);if(n===null)return e;let s=n[1];return e.split(`
`).map(r=>{let a=r.match(t.other.beginningSpace);if(a===null)return r;let[o]=a;return o.length>=s.length?r.slice(s.length):r}).join(`
`)}var j=class{options;rules;lexer;constructor(i){this.options=i||T}space(i){let e=this.rules.block.newline.exec(i);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(i){let e=this.rules.block.code.exec(i);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:R(t,`
`)}}}fences(i){let e=this.rules.block.fences.exec(i);if(e){let t=e[0],n=It(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:n}}}heading(i){let e=this.rules.block.heading.exec(i);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let n=R(t,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(t=n.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(i){let e=this.rules.block.hr.exec(i);if(e)return{type:"hr",raw:R(e[0],`
`)}}blockquote(i){let e=this.rules.block.blockquote.exec(i);if(e){let t=R(e[0],`
`).split(`
`),n="",s="",r=[];for(;t.length>0;){let a=!1,o=[],c;for(c=0;c<t.length;c++)if(this.rules.other.blockquoteStart.test(t[c]))o.push(t[c]),a=!0;else if(!a)o.push(t[c]);else break;t=t.slice(c);let l=o.join(`
`),h=l.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${l}`:l,s=s?`${s}
${h}`:h;let d=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(h,r,!0),this.lexer.state.top=d,t.length===0)break;let p=r.at(-1);if(p?.type==="code")break;if(p?.type==="blockquote"){let f=p,m=f.raw+`
`+t.join(`
`),b=this.blockquote(m);r[r.length-1]=b,n=n.substring(0,n.length-f.raw.length)+b.raw,s=s.substring(0,s.length-f.text.length)+b.text;break}else if(p?.type==="list"){let f=p,m=f.raw+`
`+t.join(`
`),b=this.list(m);r[r.length-1]=b,n=n.substring(0,n.length-p.raw.length)+b.raw,s=s.substring(0,s.length-f.raw.length)+b.raw,t=m.substring(r.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:r,text:s}}}list(i){let e=this.rules.block.list.exec(i);if(e){let t=e[1].trim(),n=t.length>1,s={type:"list",raw:"",ordered:n,start:n?+t.slice(0,-1):"",loose:!1,items:[]};t=n?`\\d{1,9}\\${t.slice(-1)}`:`\\${t}`,this.options.pedantic&&(t=n?t:"[*+-]");let r=this.rules.other.listItemRegex(t),a=!1;for(;i;){let c=!1,l="",h="";if(!(e=r.exec(i))||this.rules.block.hr.test(i))break;l=e[0],i=i.substring(l.length);let d=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,$=>" ".repeat(3*$.length)),p=i.split(`
`,1)[0],f=!d.trim(),m=0;if(this.options.pedantic?(m=2,h=d.trimStart()):f?m=e[1].length+1:(m=e[2].search(this.rules.other.nonSpaceChar),m=m>4?1:m,h=d.slice(m),m+=e[1].length),f&&this.rules.other.blankLine.test(p)&&(l+=p+`
`,i=i.substring(p.length+1),c=!0),!c){let $=this.rules.other.nextBulletRegex(m),ve=this.rules.other.hrRegex(m),ke=this.rules.other.fencesBeginRegex(m),ye=this.rules.other.headingBeginRegex(m),Ze=this.rules.other.htmlBeginRegex(m);for(;i;){let te=i.split(`
`,1)[0],L;if(p=te,this.options.pedantic?(p=p.replace(this.rules.other.listReplaceNesting,"  "),L=p):L=p.replace(this.rules.other.tabCharGlobal,"    "),ke.test(p)||ye.test(p)||Ze.test(p)||$.test(p)||ve.test(p))break;if(L.search(this.rules.other.nonSpaceChar)>=m||!p.trim())h+=`
`+L.slice(m);else{if(f||d.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||ke.test(d)||ye.test(d)||ve.test(d))break;h+=`
`+p}!f&&!p.trim()&&(f=!0),l+=te+`
`,i=i.substring(te.length+1),d=L.slice(m)}}s.loose||(a?s.loose=!0:this.rules.other.doubleBlankLine.test(l)&&(a=!0));let b=null,M;this.options.gfm&&(b=this.rules.other.listIsTask.exec(h),b&&(M=b[0]!=="[ ] ",h=h.replace(this.rules.other.listReplaceTask,""))),s.items.push({type:"list_item",raw:l,task:!!b,checked:M,loose:!1,text:h,tokens:[]}),s.raw+=l}let o=s.items.at(-1);if(o)o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd();else return;s.raw=s.raw.trimEnd();for(let c=0;c<s.items.length;c++)if(this.lexer.state.top=!1,s.items[c].tokens=this.lexer.blockTokens(s.items[c].text,[]),!s.loose){let l=s.items[c].tokens.filter(d=>d.type==="space"),h=l.length>0&&l.some(d=>this.rules.other.anyLine.test(d.raw));s.loose=h}if(s.loose)for(let c=0;c<s.items.length;c++)s.items[c].loose=!0;return s}}html(i){let e=this.rules.block.html.exec(i);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(i){let e=this.rules.block.def.exec(i);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:n,title:s}}}table(i){let e=this.rules.block.table.exec(i);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=_e(e[1]),n=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),s=e[3]?.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],r={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===n.length){for(let a of n)this.rules.other.tableAlignRight.test(a)?r.align.push("right"):this.rules.other.tableAlignCenter.test(a)?r.align.push("center"):this.rules.other.tableAlignLeft.test(a)?r.align.push("left"):r.align.push(null);for(let a=0;a<t.length;a++)r.header.push({text:t[a],tokens:this.lexer.inline(t[a]),header:!0,align:r.align[a]});for(let a of s)r.rows.push(_e(a,r.header.length).map((o,c)=>({text:o,tokens:this.lexer.inline(o),header:!1,align:r.align[c]})));return r}}lheading(i){let e=this.rules.block.lheading.exec(i);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(i){let e=this.rules.block.paragraph.exec(i);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(i){let e=this.rules.block.text.exec(i);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(i){let e=this.rules.inline.escape.exec(i);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(i){let e=this.rules.inline.tag.exec(i);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(i){let e=this.rules.inline.link.exec(i);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let r=R(t.slice(0,-1),"\\");if((t.length-r.length)%2===0)return}else{let r=zt(e[2],"()");if(r===-2)return;if(r>-1){let o=(e[0].indexOf("!")===0?5:4)+e[1].length+r;e[2]=e[2].substring(0,r),e[0]=e[0].substring(0,o).trim(),e[3]=""}}let n=e[2],s="";if(this.options.pedantic){let r=this.rules.other.pedanticHrefTitle.exec(n);r&&(n=r[1],s=r[3])}else s=e[3]?e[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?n=n.slice(1):n=n.slice(1,-1)),Ee(e,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:s&&s.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(i,e){let t;if((t=this.rules.inline.reflink.exec(i))||(t=this.rules.inline.nolink.exec(i))){let n=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),s=e[n.toLowerCase()];if(!s){let r=t[0].charAt(0);return{type:"text",raw:r,text:r}}return Ee(t,s,t[0],this.lexer,this.rules)}}emStrong(i,e,t=""){let n=this.rules.inline.emStrongLDelim.exec(i);if(!n||n[3]&&t.match(this.rules.other.unicodeAlphaNumeric))return;if(!(n[1]||n[2]||"")||!t||this.rules.inline.punctuation.exec(t)){let r=[...n[0]].length-1,a,o,c=r,l=0,h=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(h.lastIndex=0,e=e.slice(-1*i.length+r);(n=h.exec(e))!=null;){if(a=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!a)continue;if(o=[...a].length,n[3]||n[4]){c+=o;continue}else if((n[5]||n[6])&&r%3&&!((r+o)%3)){l+=o;continue}if(c-=o,c>0)continue;o=Math.min(o,o+c+l);let d=[...n[0]][0].length,p=i.slice(0,r+n.index+d+o);if(Math.min(r,o)%2){let m=p.slice(1,-1);return{type:"em",raw:p,text:m,tokens:this.lexer.inlineTokens(m)}}let f=p.slice(2,-2);return{type:"strong",raw:p,text:f,tokens:this.lexer.inlineTokens(f)}}}}codespan(i){let e=this.rules.inline.code.exec(i);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),n=this.rules.other.nonSpaceChar.test(t),s=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return n&&s&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(i){let e=this.rules.inline.br.exec(i);if(e)return{type:"br",raw:e[0]}}del(i){let e=this.rules.inline.del.exec(i);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(i){let e=this.rules.inline.autolink.exec(i);if(e){let t,n;return e[2]==="@"?(t=e[1],n="mailto:"+t):(t=e[1],n=t),{type:"link",raw:e[0],text:t,href:n,tokens:[{type:"text",raw:t,text:t}]}}}url(i){let e;if(e=this.rules.inline.url.exec(i)){let t,n;if(e[2]==="@")t=e[0],n="mailto:"+t;else{let s;do s=e[0],e[0]=this.rules.inline._backpedal.exec(e[0])?.[0]??"";while(s!==e[0]);t=e[0],e[1]==="www."?n="http://"+e[0]:n=e[0]}return{type:"link",raw:e[0],text:t,href:n,tokens:[{type:"text",raw:t,text:t}]}}}inlineText(i){let e=this.rules.inline.text.exec(i);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},k=class se{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||T,this.options.tokenizer=this.options.tokenizer||new j,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:x,block:N.normal,inline:A.normal};this.options.pedantic?(t.block=N.pedantic,t.inline=A.pedantic):this.options.gfm&&(t.block=N.gfm,this.options.breaks?t.inline=A.breaks:t.inline=A.gfm),this.tokenizer.rules=t}static get rules(){return{block:N,inline:A}}static lex(e,t){return new se(t).lex(e)}static lexInline(e,t){return new se(t).inlineTokens(e)}lex(e){e=e.replace(x.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let n=this.inlineQueue[t];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(x.tabCharGlobal,"    ").replace(x.spaceLine,""));e;){let s;if(this.options.extensions?.block?.some(a=>(s=a.call({lexer:this},e,t))?(e=e.substring(s.raw.length),t.push(s),!0):!1))continue;if(s=this.tokenizer.space(e)){e=e.substring(s.raw.length);let a=t.at(-1);s.raw.length===1&&a!==void 0?a.raw+=`
`:t.push(s);continue}if(s=this.tokenizer.code(e)){e=e.substring(s.raw.length);let a=t.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.at(-1).src=a.text):t.push(s);continue}if(s=this.tokenizer.fences(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.heading(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.hr(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.blockquote(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.list(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.html(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.def(e)){e=e.substring(s.raw.length);let a=t.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.raw,this.inlineQueue.at(-1).src=a.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title});continue}if(s=this.tokenizer.table(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.lheading(e)){e=e.substring(s.raw.length),t.push(s);continue}let r=e;if(this.options.extensions?.startBlock){let a=1/0,o=e.slice(1),c;this.options.extensions.startBlock.forEach(l=>{c=l.call({lexer:this},o),typeof c=="number"&&c>=0&&(a=Math.min(a,c))}),a<1/0&&a>=0&&(r=e.substring(0,a+1))}if(this.state.top&&(s=this.tokenizer.paragraph(r))){let a=t.at(-1);n&&a?.type==="paragraph"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):t.push(s),n=r.length!==e.length,e=e.substring(s.raw.length);continue}if(s=this.tokenizer.text(e)){e=e.substring(s.raw.length);let a=t.at(-1);a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):t.push(s);continue}if(e){let a="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(a);break}else throw new Error(a)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,s=null;if(this.tokens.links){let o=Object.keys(this.tokens.links);if(o.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)o.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,s.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;(s=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let r=!1,a="";for(;e;){r||(a=""),r=!1;let o;if(this.options.extensions?.inline?.some(l=>(o=l.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.escape(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.tag(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.link(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(o.raw.length);let l=t.at(-1);o.type==="text"&&l?.type==="text"?(l.raw+=o.raw,l.text+=o.text):t.push(o);continue}if(o=this.tokenizer.emStrong(e,n,a)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.codespan(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.br(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.del(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.autolink(e)){e=e.substring(o.raw.length),t.push(o);continue}if(!this.state.inLink&&(o=this.tokenizer.url(e))){e=e.substring(o.raw.length),t.push(o);continue}let c=e;if(this.options.extensions?.startInline){let l=1/0,h=e.slice(1),d;this.options.extensions.startInline.forEach(p=>{d=p.call({lexer:this},h),typeof d=="number"&&d>=0&&(l=Math.min(l,d))}),l<1/0&&l>=0&&(c=e.substring(0,l+1))}if(o=this.tokenizer.inlineText(c)){e=e.substring(o.raw.length),o.raw.slice(-1)!=="_"&&(a=o.raw.slice(-1)),r=!0;let l=t.at(-1);l?.type==="text"?(l.raw+=o.raw,l.text+=o.text):t.push(o);continue}if(e){let l="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(l);break}else throw new Error(l)}}return t}},F=class{options;parser;constructor(i){this.options=i||T}space(i){return""}code({text:i,lang:e,escaped:t}){let n=(e||"").match(x.notSpaceStart)?.[0],s=i.replace(x.endingNewline,"")+`
`;return n?'<pre><code class="language-'+v(n)+'">'+(t?s:v(s,!0))+`</code></pre>
`:"<pre><code>"+(t?s:v(s,!0))+`</code></pre>
`}blockquote({tokens:i}){return`<blockquote>
${this.parser.parse(i)}</blockquote>
`}html({text:i}){return i}heading({tokens:i,depth:e}){return`<h${e}>${this.parser.parseInline(i)}</h${e}>
`}hr(i){return`<hr>
`}list(i){let e=i.ordered,t=i.start,n="";for(let a=0;a<i.items.length;a++){let o=i.items[a];n+=this.listitem(o)}let s=e?"ol":"ul",r=e&&t!==1?' start="'+t+'"':"";return"<"+s+r+`>
`+n+"</"+s+`>
`}listitem(i){let e="";if(i.task){let t=this.checkbox({checked:!!i.checked});i.loose?i.tokens[0]?.type==="paragraph"?(i.tokens[0].text=t+" "+i.tokens[0].text,i.tokens[0].tokens&&i.tokens[0].tokens.length>0&&i.tokens[0].tokens[0].type==="text"&&(i.tokens[0].tokens[0].text=t+" "+v(i.tokens[0].tokens[0].text),i.tokens[0].tokens[0].escaped=!0)):i.tokens.unshift({type:"text",raw:t+" ",text:t+" ",escaped:!0}):e+=t+" "}return e+=this.parser.parse(i.tokens,!!i.loose),`<li>${e}</li>
`}checkbox({checked:i}){return"<input "+(i?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:i}){return`<p>${this.parser.parseInline(i)}</p>
`}table(i){let e="",t="";for(let s=0;s<i.header.length;s++)t+=this.tablecell(i.header[s]);e+=this.tablerow({text:t});let n="";for(let s=0;s<i.rows.length;s++){let r=i.rows[s];t="";for(let a=0;a<r.length;a++)t+=this.tablecell(r[a]);n+=this.tablerow({text:t})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+n+`</table>
`}tablerow({text:i}){return`<tr>
${i}</tr>
`}tablecell(i){let e=this.parser.parseInline(i.tokens),t=i.header?"th":"td";return(i.align?`<${t} align="${i.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:i}){return`<strong>${this.parser.parseInline(i)}</strong>`}em({tokens:i}){return`<em>${this.parser.parseInline(i)}</em>`}codespan({text:i}){return`<code>${v(i,!0)}</code>`}br(i){return"<br>"}del({tokens:i}){return`<del>${this.parser.parseInline(i)}</del>`}link({href:i,title:e,tokens:t}){let n=this.parser.parseInline(t),s=Te(i);if(s===null)return n;i=s;let r='<a href="'+i+'"';return e&&(r+=' title="'+v(e)+'"'),r+=">"+n+"</a>",r}image({href:i,title:e,text:t,tokens:n}){n&&(t=this.parser.parseInline(n,this.parser.textRenderer));let s=Te(i);if(s===null)return v(t);i=s;let r=`<img src="${i}" alt="${t}"`;return e&&(r+=` title="${v(e)}"`),r+=">",r}text(i){return"tokens"in i&&i.tokens?this.parser.parseInline(i.tokens):"escaped"in i&&i.escaped?i.text:v(i.text)}},ue=class{strong({text:i}){return i}em({text:i}){return i}codespan({text:i}){return i}del({text:i}){return i}html({text:i}){return i}text({text:i}){return i}link({text:i}){return""+i}image({text:i}){return""+i}br(){return""}},y=class re{options;renderer;textRenderer;constructor(e){this.options=e||T,this.options.renderer=this.options.renderer||new F,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new ue}static parse(e,t){return new re(t).parse(e)}static parseInline(e,t){return new re(t).parseInline(e)}parse(e,t=!0){let n="";for(let s=0;s<e.length;s++){let r=e[s];if(this.options.extensions?.renderers?.[r.type]){let o=r,c=this.options.extensions.renderers[o.type].call({parser:this},o);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(o.type)){n+=c||"";continue}}let a=r;switch(a.type){case"space":{n+=this.renderer.space(a);continue}case"hr":{n+=this.renderer.hr(a);continue}case"heading":{n+=this.renderer.heading(a);continue}case"code":{n+=this.renderer.code(a);continue}case"table":{n+=this.renderer.table(a);continue}case"blockquote":{n+=this.renderer.blockquote(a);continue}case"list":{n+=this.renderer.list(a);continue}case"html":{n+=this.renderer.html(a);continue}case"paragraph":{n+=this.renderer.paragraph(a);continue}case"text":{let o=a,c=this.renderer.text(o);for(;s+1<e.length&&e[s+1].type==="text";)o=e[++s],c+=`
`+this.renderer.text(o);t?n+=this.renderer.paragraph({type:"paragraph",raw:c,text:c,tokens:[{type:"text",raw:c,text:c,escaped:!0}]}):n+=c;continue}default:{let o='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}parseInline(e,t=this.renderer){let n="";for(let s=0;s<e.length;s++){let r=e[s];if(this.options.extensions?.renderers?.[r.type]){let o=this.options.extensions.renderers[r.type].call({parser:this},r);if(o!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(r.type)){n+=o||"";continue}}let a=r;switch(a.type){case"escape":{n+=t.text(a);break}case"html":{n+=t.html(a);break}case"link":{n+=t.link(a);break}case"image":{n+=t.image(a);break}case"strong":{n+=t.strong(a);break}case"em":{n+=t.em(a);break}case"codespan":{n+=t.codespan(a);break}case"br":{n+=t.br(a);break}case"del":{n+=t.del(a);break}case"text":{n+=t.text(a);break}default:{let o='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}},q=class{options;block;constructor(i){this.options=i||T}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(i){return i}postprocess(i){return i}processAllTokens(i){return i}provideLexer(){return this.block?k.lex:k.lexInline}provideParser(){return this.block?y.parse:y.parseInline}},Ht=class{defaults=ae();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=y;Renderer=F;TextRenderer=ue;Lexer=k;Tokenizer=j;Hooks=q;constructor(...i){this.use(...i)}walkTokens(i,e){let t=[];for(let n of i)switch(t=t.concat(e.call(this,n)),n.type){case"table":{let s=n;for(let r of s.header)t=t.concat(this.walkTokens(r.tokens,e));for(let r of s.rows)for(let a of r)t=t.concat(this.walkTokens(a.tokens,e));break}case"list":{let s=n;t=t.concat(this.walkTokens(s.items,e));break}default:{let s=n;this.defaults.extensions?.childTokens?.[s.type]?this.defaults.extensions.childTokens[s.type].forEach(r=>{let a=s[r].flat(1/0);t=t.concat(this.walkTokens(a,e))}):s.tokens&&(t=t.concat(this.walkTokens(s.tokens,e)))}}return t}use(...i){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return i.forEach(t=>{let n={...t};if(n.async=this.defaults.async||n.async||!1,t.extensions&&(t.extensions.forEach(s=>{if(!s.name)throw new Error("extension name required");if("renderer"in s){let r=e.renderers[s.name];r?e.renderers[s.name]=function(...a){let o=s.renderer.apply(this,a);return o===!1&&(o=r.apply(this,a)),o}:e.renderers[s.name]=s.renderer}if("tokenizer"in s){if(!s.level||s.level!=="block"&&s.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let r=e[s.level];r?r.unshift(s.tokenizer):e[s.level]=[s.tokenizer],s.start&&(s.level==="block"?e.startBlock?e.startBlock.push(s.start):e.startBlock=[s.start]:s.level==="inline"&&(e.startInline?e.startInline.push(s.start):e.startInline=[s.start]))}"childTokens"in s&&s.childTokens&&(e.childTokens[s.name]=s.childTokens)}),n.extensions=e),t.renderer){let s=this.defaults.renderer||new F(this.defaults);for(let r in t.renderer){if(!(r in s))throw new Error(`renderer '${r}' does not exist`);if(["options","parser"].includes(r))continue;let a=r,o=t.renderer[a],c=s[a];s[a]=(...l)=>{let h=o.apply(s,l);return h===!1&&(h=c.apply(s,l)),h||""}}n.renderer=s}if(t.tokenizer){let s=this.defaults.tokenizer||new j(this.defaults);for(let r in t.tokenizer){if(!(r in s))throw new Error(`tokenizer '${r}' does not exist`);if(["options","rules","lexer"].includes(r))continue;let a=r,o=t.tokenizer[a],c=s[a];s[a]=(...l)=>{let h=o.apply(s,l);return h===!1&&(h=c.apply(s,l)),h}}n.tokenizer=s}if(t.hooks){let s=this.defaults.hooks||new q;for(let r in t.hooks){if(!(r in s))throw new Error(`hook '${r}' does not exist`);if(["options","block"].includes(r))continue;let a=r,o=t.hooks[a],c=s[a];q.passThroughHooks.has(r)?s[a]=l=>{if(this.defaults.async)return Promise.resolve(o.call(s,l)).then(d=>c.call(s,d));let h=o.call(s,l);return c.call(s,h)}:s[a]=(...l)=>{let h=o.apply(s,l);return h===!1&&(h=c.apply(s,l)),h}}n.hooks=s}if(t.walkTokens){let s=this.defaults.walkTokens,r=t.walkTokens;n.walkTokens=function(a){let o=[];return o.push(r.call(this,a)),s&&(o=o.concat(s.call(this,a))),o}}this.defaults={...this.defaults,...n}}),this}setOptions(i){return this.defaults={...this.defaults,...i},this}lexer(i,e){return k.lex(i,e??this.defaults)}parser(i,e){return y.parse(i,e??this.defaults)}parseMarkdown(i){return(t,n)=>{let s={...n},r={...this.defaults,...s},a=this.onError(!!r.silent,!!r.async);if(this.defaults.async===!0&&s.async===!1)return a(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return a(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return a(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));r.hooks&&(r.hooks.options=r,r.hooks.block=i);let o=r.hooks?r.hooks.provideLexer():i?k.lex:k.lexInline,c=r.hooks?r.hooks.provideParser():i?y.parse:y.parseInline;if(r.async)return Promise.resolve(r.hooks?r.hooks.preprocess(t):t).then(l=>o(l,r)).then(l=>r.hooks?r.hooks.processAllTokens(l):l).then(l=>r.walkTokens?Promise.all(this.walkTokens(l,r.walkTokens)).then(()=>l):l).then(l=>c(l,r)).then(l=>r.hooks?r.hooks.postprocess(l):l).catch(a);try{r.hooks&&(t=r.hooks.preprocess(t));let l=o(t,r);r.hooks&&(l=r.hooks.processAllTokens(l)),r.walkTokens&&this.walkTokens(l,r.walkTokens);let h=c(l,r);return r.hooks&&(h=r.hooks.postprocess(h)),h}catch(l){return a(l)}}}onError(i,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,i){let n="<p>An error occurred:</p><pre>"+v(t.message+"",!0)+"</pre>";return e?Promise.resolve(n):n}if(e)return Promise.reject(t);throw t}}},C=new Ht;function g(i,e){return C.parse(i,e)}g.options=g.setOptions=function(i){return C.setOptions(i),g.defaults=C.defaults,Me(g.defaults),g};g.getDefaults=ae;g.defaults=T;g.use=function(...i){return C.use(...i),g.defaults=C.defaults,Me(g.defaults),g};g.walkTokens=function(i,e){return C.walkTokens(i,e)};g.parseInline=C.parseInline;g.Parser=y;g.parser=y.parse;g.Renderer=F;g.TextRenderer=ue;g.Lexer=k;g.lexer=k.lex;g.Tokenizer=j;g.Hooks=q;g.parse=g;var Xt=g.options,Kt=g.setOptions,Yt=g.use,Jt=g.walkTokens,ei=g.parseInline;var ti=y.parse,ii=k.lex;var me="chat-widget-container",S=null,H=null;function Oe(){let i=document.getElementById(me);i&&i.remove();let e=document.createElement("div");return e.id=me,e.setAttribute("role","complementary"),e.setAttribute("aria-label","AI Chat Widget"),e.style.cssText=`
    position: fixed !important;
    z-index: 99999 !important;
    top: 0 !important;
    left: 0 !important;
    width: 0 !important;
    height: 0 !important;
    overflow: visible !important;
    pointer-events: none !important;
  `,S=e.attachShadow({mode:"open"}),H=document.createElement("div"),H.className="chat-widget-root",S.appendChild(H),document.body.appendChild(e),H}function Ne(i){if(!S){console.warn("[ChatWidget] Cannot inject styles: Shadow root not initialized");return}let e=S.querySelector("style");e||(e=document.createElement("style"),S.insertBefore(e,S.firstChild)),e.textContent=i}function qe(){document.getElementById(me)?.remove(),S=null,H=null}var Pt=/[\u0591-\u07FF\u200F\u202B\u202E\uFB1D-\uFDFD\uFE70-\uFEFC]/;function Bt(i){return Pt.test(i)}function fe(i,e){Bt(e)?i.setAttribute("dir","rtl"):i.setAttribute("dir","ltr")}function w(i){let e=document.createElement("div");return e.textContent=i,e.innerHTML}function _(){return`${Date.now()}-${Math.random().toString(36).substring(2,11)}`}function E(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}function we(){return window.matchMedia("(max-width: 768px)").matches}function We(i){requestAnimationFrame(()=>{i.scrollTop=i.scrollHeight})}function je(i){let e='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',t=null;function n(){return Array.from(i.querySelectorAll(e))}function s(r){if(r.key!=="Tab")return;let a=n();if(a.length===0)return;let o=a[0],c=a[a.length-1],l=S?.activeElement||document.activeElement;r.shiftKey&&l===o?(r.preventDefault(),c.focus()):!r.shiftKey&&l===c&&(r.preventDefault(),o.focus())}return{activate(){t=document.activeElement,i.addEventListener("keydown",s);let r=n();r.length>0&&r[0].focus()},deactivate(){i.removeEventListener("keydown",s),t&&t.focus()}}}function G(i){let e=document.createElement("div");e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="chat-widget-sr-only",e.style.cssText=`
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  `,document.body.appendChild(e),setTimeout(()=>{e.textContent=i},100),setTimeout(()=>{e.remove()},1e3)}var xe={keyword:["const","let","var","function","return","if","else","for","while","do","switch","case","break","continue","try","catch","finally","throw","class","extends","new","this","super","import","export","from","as","default","async","await","yield","static","get","set","typeof","instanceof","in","of","delete","void","null","undefined","true","false","def","print","elif","except","pass","with","lambda","global","nonlocal","raise","assert","and","or","not","is","None","True","False"],type:["string","number","boolean","object","array","any","void","never","int","float","str","list","dict","tuple","set","bool","String","Number","Boolean","Object","Array","Promise","Map","Set"],builtin:["console","window","document","Math","JSON","Date","Error","setTimeout","setInterval","fetch","require","module","exports","len","range","enumerate","zip","map","filter","sorted","reversed","input","open","type","isinstance","hasattr","getattr","setattr"]};function Dt(i,e){let t=w(i);if(!e||e==="text"||e==="plaintext")return t;let n=t;n=n.replace(/(["'`])(?:(?!\1)[^\\]|\\.)*\1/g,'<span class="chat-widget-hl-string">$&</span>'),n=n.replace(/(\/\/[^\n]*|#[^\n]*|\/\*[\s\S]*?\*\/)/g,'<span class="chat-widget-hl-comment">$&</span>'),n=n.replace(/\b(\d+\.?\d*)\b/g,'<span class="chat-widget-hl-number">$1</span>');let s=new RegExp(`\\b(${xe.keyword.join("|")})\\b`,"g");n=n.replace(s,'<span class="chat-widget-hl-keyword">$1</span>');let r=new RegExp(`\\b(${xe.type.join("|")})\\b`,"g");n=n.replace(r,'<span class="chat-widget-hl-type">$1</span>');let a=new RegExp(`\\b(${xe.builtin.join("|")})\\b`,"g");return n=n.replace(a,'<span class="chat-widget-hl-builtin">$1</span>'),n}var V=class{constructor(e){this.config=e,this.markedInstance=g,this.initializeMarked()}initializeMarked(){let e={gfm:!0,breaks:!0,async:!1};this.markedInstance.setOptions(e);let t=new g.Renderer;t.code=({text:n,lang:s})=>{let r=s||"text",a=this.config.syntaxHighlighting?Dt(n,r):w(n);return`<div class="chat-widget-code-block">
        <div class="chat-widget-code-header">${r!=="text"?`<span class="chat-widget-code-lang">${w(r)}</span>`:""}<button class="chat-widget-code-copy" aria-label="Copy code" title="Copy code">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button></div>
        <pre><code class="language-${w(r)}">${a}</code></pre>
      </div>`},t.codespan=({text:n})=>`<code class="chat-widget-inline-code">${w(n)}</code>`,t.link=({href:n,title:s,text:r})=>{let a=["http:","https:","mailto:"],o="#";try{let l=new URL(n,window.location.origin);a.includes(l.protocol)&&(o=n)}catch{}let c=s?` title="${w(s)}"`:"";return`<a href="${w(o)}" target="_blank" rel="noopener noreferrer"${c}>${r}</a>`},t.image=({href:n,title:s,text:r})=>{let a=s?` title="${w(s)}"`:"";return`<img src="${w(n)}" alt="${w(r)}"${a} class="chat-widget-image" loading="lazy">`},t.listitem=({text:n,task:s,checked:r})=>s?`<li class="chat-widget-task-item">${r?'<span class="chat-widget-checkbox chat-widget-checkbox--checked">&#x2611;</span>':'<span class="chat-widget-checkbox">&#x2610;</span>'}${n}</li>`:`<li>${n}</li>`,this.markedInstance.use({renderer:t})}render(e){if(!this.config.enableMarkdown)return this.renderPlainText(e);try{return`<div class="chat-widget-markdown">${this.markedInstance.parse(e)}</div>`}catch(t){return console.warn("[ChatWidget] Markdown parsing failed:",t),this.renderPlainText(e)}}renderProgressive(e,t){if(!this.config.enableMarkdown)return this.renderPlainText(e);let n=e;if((e.match(/```/g)||[]).length%2!==0&&!t){let a=e.lastIndexOf("```");e.substring(a).includes("\n```")||(n=e+"\n```")}try{return`<div class="chat-widget-markdown">${this.markedInstance.parse(n)}</div>`}catch{return this.renderPlainText(e)}}renderPlainText(e){return`<div class="chat-widget-plaintext">${w(e).replace(/\n/g,"<br>")}</div>`}renderUserMessage(e){return this.renderPlainText(e)}};function be(i){i.querySelectorAll(".chat-widget-code-copy").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation();let s=e.closest(".chat-widget-code-block")?.querySelector("code")?.textContent;if(s)try{await navigator.clipboard.writeText(s),e.classList.add("chat-widget-code-copy--success"),setTimeout(()=>{e.classList.remove("chat-widget-code-copy--success")},2e3)}catch(r){console.warn("[ChatWidget] Failed to copy code:",r)}})})}var Q=class{constructor(e){this.session=null;this.config=e}initialize(){if(this.config.persistSession){let e=this.loadFromStorage();if(e)return this.session=e,e}return this.session=this.createNew(),this.save(),this.session}getSession(){return this.session?this.session:this.initialize()}getConversationId(){return this.getSession().conversationId}getMessages(){return this.getSession().messages}addMessage(e){this.session||this.initialize(),this.session.messages.push(e),this.session.updatedAt=Date.now(),this.save()}updateMessage(e,t){if(!this.session)return;let n=this.session.messages.findIndex(s=>s.id===e);n!==-1&&(this.session.messages[n]={...this.session.messages[n],...t},this.session.updatedAt=Date.now(),this.save())}getMessage(e){return this.session?.messages.find(t=>t.id===e)}clear(){this.session=this.createNew(),this.save()}createNew(){return{id:_(),conversationId:_(),messages:[],createdAt:Date.now(),updatedAt:Date.now()}}save(){if(!(!this.config.persistSession||!this.session))try{localStorage.setItem(this.config.sessionStorageKey,JSON.stringify(this.session))}catch(e){console.warn("[ChatWidget] Failed to save session:",e)}}loadFromStorage(){try{let e=localStorage.getItem(this.config.sessionStorageKey);if(e){let t=JSON.parse(e);if(this.isValidSession(t))return t}}catch(e){console.warn("[ChatWidget] Failed to load session:",e)}return null}isValidSession(e){if(!e||typeof e!="object")return!1;let t=e;return typeof t.id=="string"&&typeof t.conversationId=="string"&&Array.isArray(t.messages)&&typeof t.createdAt=="number"&&typeof t.updatedAt=="number"}createUserMessage(e){return{id:_(),role:"user",content:e,timestamp:Date.now(),status:"complete"}}createAssistantMessage(){return{id:_(),role:"assistant",content:"",timestamp:Date.now(),status:"streaming"}}};var X=class{constructor(e){this.config=e}extractContext(){if(!this.config.includePageContext)return null;try{let e=document.body;this.config.pageContextSelector&&(e=document.querySelector(this.config.pageContextSelector),e||(console.warn(`[ChatWidget] pageContextSelector "${this.config.pageContextSelector}" not found`),e=document.body));let t=this.extractFromElement(e),n=8e3;return t.length>n?t.substring(0,n)+`

[Content truncated...]`:t}catch(e){return console.error("[ChatWidget] Error extracting page context:",e),null}}extractFromElement(e){let t=[],n=document.title;n&&t.push(`Page Title: ${n}`);let s=window.location.origin+window.location.pathname;t.push(`URL: ${s}`),t.push(""),t.push("--- Page Content ---"),t.push("");let r=this.extractTextContent(e);t.push(r);let a=this.extractTables(e);a&&(t.push(""),t.push("--- Data Tables ---"),t.push(a));let o=this.extractForms(e);return o&&(t.push(""),t.push("--- Form Fields ---"),t.push(o)),t.join(`
`)}extractTextContent(e){let t=[],n=new Set(["SCRIPT","STYLE","NOSCRIPT","SVG","PATH","IFRAME","TEMPLATE"]),s=["chat-widget","chatwidget"],r=(a,o=0)=>{if(a.nodeType===Node.ELEMENT_NODE){let c=a;if(n.has(c.tagName)||c.id?.toLowerCase().includes("chat-widget")||s.some(h=>c.className?.toString().toLowerCase().includes(h)))return;let l=c.tagName;if(/^H[1-6]$/.test(l)){let h=parseInt(l[1]),d="#".repeat(h),p=c.textContent?.trim();p&&(t.push(""),t.push(`${d} ${p}`));return}if(l==="LI"){let h=this.getDirectText(c);h&&t.push(`  \u2022 ${h}`)}if(l==="A"){let h=c.textContent?.trim(),d=c.getAttribute("href");h&&d&&!d.startsWith("#")&&!d.startsWith("javascript:")&&t.push(`[${h}]`);return}if(l==="P"||l==="DIV"||l==="SPAN"){let h=this.getDirectText(c);h&&h.length>10&&t.push(h)}for(let h of c.childNodes)r(h,o+1)}else a.nodeType,Node.TEXT_NODE};return r(e),t.filter(a=>a.trim().length>0).filter((a,o,c)=>c.indexOf(a)===o).join(`
`)}getDirectText(e){let t="";for(let n of e.childNodes)n.nodeType===Node.TEXT_NODE&&(t+=n.textContent);return t.trim()}extractTables(e){let t=e.querySelectorAll("table");if(t.length===0)return null;let n=[];return t.forEach((s,r)=>{if(s.closest("#chat-widget-container"))return;let a=s.querySelectorAll("tr");a.length!==0&&(n.push(`
Table ${r+1}:`),a.forEach((o,c)=>{let l=o.querySelectorAll("th, td"),h=Array.from(l).map(d=>d.textContent?.trim()||"");n.push(`| ${h.join(" | ")} |`),c===0&&o.querySelector("th")&&n.push(`| ${h.map(()=>"---").join(" | ")} |`)}))}),n.length>0?n.join(`
`):null}extractForms(e){let t=e.querySelectorAll("input, select, textarea");if(t.length===0)return null;let n=[];return t.forEach(s=>{if(s.closest("#chat-widget-container"))return;let r=s,a=this.findLabelFor(r),o=r.tagName==="INPUT"?r.type:r.tagName.toLowerCase(),c=r.name||r.id||"unnamed",l=r.value||"";if(o==="password")n.push(`- ${a||c} (${o}): [hidden]`);else if(o!=="hidden")if(r.tagName==="SELECT"){let h=r,d=h.options[h.selectedIndex];n.push(`- ${a||c} (select): ${d?.text||"none"}`)}else n.push(`- ${a||c} (${o}): ${l||"[empty]"}`)}),n.length>0?n.join(`
`):null}findLabelFor(e){let t=e.id;if(t){let a=document.querySelector(`label[for="${t}"]`);if(a)return a.textContent?.trim()||null}let n=e.closest("label");if(n){let a=this.getDirectText(n);if(a)return a}let s=e.getAttribute("aria-label");if(s)return s;let r=e.getAttribute("placeholder");return r||null}};var Fe=`
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
</svg>
`,Ot=`
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <line x1="18" y1="6" x2="6" y2="18"></line>
  <line x1="6" y1="6" x2="18" y2="18"></line>
</svg>
`,K=class{constructor(e){this._isOpen=!1;this.badgeElement=null;this.options=e,this.element=this.render()}render(){let e=document.createElement("button");if(e.className="chat-widget-avatar",e.setAttribute("aria-label","Open chat"),e.setAttribute("aria-haspopup","dialog"),e.setAttribute("aria-expanded","false"),e.setAttribute("type","button"),e.classList.add(`chat-widget-avatar--${this.options.position}`),e.style.width=`${this.options.size}px`,e.style.height=`${this.options.size}px`,e.style.setProperty("--chat-widget-primary",this.options.primaryColor),this.options.imageUrl){let t=document.createElement("img");t.src=this.options.imageUrl,t.alt="",t.setAttribute("aria-hidden","true"),t.className="chat-widget-avatar__image",e.appendChild(t)}else{let t=document.createElement("span");t.className="chat-widget-avatar__icon",t.innerHTML=Fe,t.setAttribute("aria-hidden","true"),e.appendChild(t)}return this.badgeElement=document.createElement("span"),this.badgeElement.className="chat-widget-avatar__badge",this.badgeElement.setAttribute("aria-hidden","true"),this.badgeElement.style.display="none",e.appendChild(this.badgeElement),e.addEventListener("click",t=>{t.preventDefault(),this.options.onClick()}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),this.options.onClick())}),E()||e.classList.add("chat-widget-avatar--animated"),e}getElement(){return this.element}isOpenState(){return this._isOpen}show(){this.element.style.display="flex",this.element.setAttribute("aria-hidden","false")}hide(){this.element.style.display="none",this.element.setAttribute("aria-hidden","true")}setOpen(e){if(this._isOpen=e,this.element.setAttribute("aria-expanded",String(e)),!this.options.imageUrl){let t=this.element.querySelector(".chat-widget-avatar__icon");t&&(t.innerHTML=e?Ot:Fe)}this.element.setAttribute("aria-label",e?"Close chat":"Open chat")}setPulse(e){e&&!E()?this.element.classList.add("chat-widget-avatar--pulse"):this.element.classList.remove("chat-widget-avatar--pulse")}showBadge(e){this.badgeElement&&(this.badgeElement.style.display="flex",e!==void 0&&e>0&&(this.badgeElement.textContent=e>9?"9+":String(e)))}hideBadge(){this.badgeElement&&(this.badgeElement.style.display="none",this.badgeElement.textContent="")}updateOptions(e){e.primaryColor&&(this.options.primaryColor=e.primaryColor,this.element.style.setProperty("--chat-widget-primary",e.primaryColor)),e.size&&(this.options.size=e.size,this.element.style.width=`${e.size}px`,this.element.style.height=`${e.size}px`)}destroy(){this.element.remove()}};var Nt=`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="4 14 10 14 10 20"></polyline>
  <polyline points="20 10 14 10 14 4"></polyline>
  <line x1="14" y1="10" x2="21" y2="3"></line>
  <line x1="3" y1="21" x2="10" y2="14"></line>
</svg>
`,qt=`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <line x1="18" y1="6" x2="6" y2="18"></line>
  <line x1="6" y1="6" x2="18" y2="18"></line>
</svg>
`,Wt=`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="3 6 5 6 21 6"></polyline>
  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
</svg>
`,Y=class{constructor(e){this.isOpen=!1;this.originalBodyStyle=null;this.options=e,this.element=this.render(),this.messagesContainer=this.element.querySelector(".chat-widget-messages"),this.inputContainer=this.element.querySelector(".chat-widget-panel__input"),this.focusTrap=je(this.element),this.setupEventListeners()}render(){let e=document.createElement("div");return e.className=`chat-widget-panel chat-widget-panel--${this.options.position}`,e.setAttribute("role","dialog"),e.setAttribute("aria-label",this.options.title),e.setAttribute("aria-modal","false"),e.setAttribute("aria-hidden","true"),e.style.width=`${this.options.width}px`,this.options.height!=="full"&&(e.style.height=`${this.options.height}px`),e.innerHTML=`
      <div class="chat-widget-panel__header">
        <div class="chat-widget-panel__title">
          <h2>${w(this.options.title)}</h2>
        </div>
        <div class="chat-widget-panel__actions">
          <button
            class="chat-widget-panel__btn chat-widget-panel__btn--clear"
            aria-label="Clear chat history"
            title="Clear History"
            type="button"
          >
            ${Wt}
          </button>
          <button
            class="chat-widget-panel__btn chat-widget-panel__btn--minimize"
            aria-label="Minimize chat"
            title="Minimize"
            type="button"
          >
            ${Nt}
          </button>
          <button
            class="chat-widget-panel__btn chat-widget-panel__btn--close"
            aria-label="Close chat"
            title="Close"
            type="button"
          >
            ${qt}
          </button>
        </div>
      </div>
      <div class="chat-widget-messages" role="log" aria-live="polite" aria-atomic="false">
        <div class="chat-widget-messages__welcome"></div>
      </div>
      <div class="chat-widget-panel__input"></div>
    `,e}setupEventListeners(){this.element.querySelector(".chat-widget-panel__btn--close")?.addEventListener("click",()=>this.options.onClose()),this.element.querySelector(".chat-widget-panel__btn--minimize")?.addEventListener("click",()=>this.options.onMinimize()),this.element.querySelector(".chat-widget-panel__btn--clear")?.addEventListener("click",()=>this.options.onClearHistory()),this.element.addEventListener("keydown",s=>{s.key==="Escape"&&(s.preventDefault(),this.options.onClose())}),window.addEventListener("resize",()=>{this.isOpen&&this.updatePushContent()})}getElement(){return this.element}getMessagesContainer(){return this.messagesContainer}getInputContainer(){return this.inputContainer}mountInput(e){this.inputContainer.appendChild(e.getElement())}open(){if(this.isOpen)return;this.isOpen=!0,this.element.classList.add("chat-widget-panel--open"),this.element.setAttribute("aria-hidden","false"),this.options.pushContent&&this.applyPushContent(!0);let e=E()?0:300;setTimeout(()=>{this.focusTrap.activate()},e)}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("chat-widget-panel--open"),this.element.setAttribute("aria-hidden","true"),this.options.pushContent&&this.applyPushContent(!1),this.focusTrap.deactivate())}isOpened(){return this.isOpen}applyPushContent(e){if(we())return;let n=this.options.position.includes("right")?"marginRight":"marginLeft";e?(this.originalBodyStyle={marginLeft:document.body.style.marginLeft,marginRight:document.body.style.marginRight,transition:document.body.style.transition},E()||(document.body.style.transition="margin 0.3s ease-in-out"),document.body.style[n]=`${this.options.width}px`):(E()||(document.body.style.transition="margin 0.3s ease-in-out"),document.body.style[n]=this.originalBodyStyle?.[n]||"",setTimeout(()=>{this.originalBodyStyle&&(document.body.style.transition=this.originalBodyStyle.transition)},300))}updatePushContent(){this.options.pushContent&&(we()?this.originalBodyStyle&&(document.body.style.marginLeft=this.originalBodyStyle.marginLeft,document.body.style.marginRight=this.originalBodyStyle.marginRight):this.applyPushContent(!0))}addMessage(e){let t=this.messagesContainer.querySelector(".chat-widget-messages__welcome");t&&t.children.length===0&&t.remove(),this.messagesContainer.appendChild(e),this.scrollToBottom()}setWelcomeMessage(e){let t=this.messagesContainer.querySelector(".chat-widget-messages__welcome");t&&(t.innerHTML=`
        <div class="chat-widget-welcome">
          <p>${w(e)}</p>
        </div>
      `)}clearMessages(){this.messagesContainer.innerHTML='<div class="chat-widget-messages__welcome"></div>'}scrollToBottom(){We(this.messagesContainer)}setTitle(e){let t=this.element.querySelector(".chat-widget-panel__title h2");t&&(t.textContent=e)}showLoading(){this.element.classList.add("chat-widget-panel--loading")}hideLoading(){this.element.classList.remove("chat-widget-panel--loading")}showError(e){let t=document.createElement("div");t.className="chat-widget-panel__error",t.innerHTML=`
      <p>${w(e)}</p>
      <button type="button" class="chat-widget-panel__error-dismiss">Dismiss</button>
    `,t.querySelector("button")?.addEventListener("click",()=>{t.remove()}),this.element.insertBefore(t,this.messagesContainer)}updateOptions(e){e.width!==void 0&&(this.options.width=e.width,this.element.style.width=`${e.width}px`,this.isOpen&&this.options.pushContent&&this.applyPushContent(!0)),e.height!==void 0&&(this.options.height=e.height,e.height!=="full"?this.element.style.height=`${e.height}px`:this.element.style.height=""),e.title!==void 0&&this.setTitle(e.title)}destroy(){this.isOpen&&this.close(),this.element.remove()}};var J=class i{constructor(e,t){this.message=e,this.markdownService=t,this.element=this.render(),this.contentElement=this.element.querySelector(".chat-widget-message__content")}render(){let e=document.createElement("div");e.className=`chat-widget-message chat-widget-message--${this.message.role}`,e.setAttribute("data-message-id",this.message.id),e.setAttribute("data-status",this.message.status),this.message.content&&fe(e,this.message.content);let t=this.message.role==="assistant";e.innerHTML=`
      ${t?'<div class="chat-widget-message__avatar" aria-hidden="true"></div>':""}
      <div class="chat-widget-message__body">
        <div class="chat-widget-message__content"></div>
        <div class="chat-widget-message__meta">
          <time datetime="${new Date(this.message.timestamp).toISOString()}">
            ${this.formatTime(this.message.timestamp)}
          </time>
        </div>
      </div>
    `;let n=e.querySelector(".chat-widget-message__content");if(this.renderContent(n),this.message.toolCalls&&this.message.toolCalls.length>0){let s=document.createElement("div");s.className="chat-widget-message__tools";let r=!1;this.message.toolCalls.forEach(a=>{let o=this.renderToolCall(a);o&&(s.appendChild(o),r=!0)}),r&&e.querySelector(".chat-widget-message__body")?.appendChild(s)}return this.message.status==="streaming"&&e.classList.add("chat-widget-message--streaming"),e}renderContent(e){let t=this.message.status==="streaming";this.message.role==="user"?e.innerHTML=this.markdownService.renderUserMessage(this.message.content):(e.innerHTML=this.markdownService.renderProgressive(this.message.content,!t),be(e))}static{this.HIDDEN_TOOLS=["getPageContent"]}renderToolCall(e){if(i.HIDDEN_TOOLS.includes(e.toolName))return null;let t=document.createElement("div");t.className=`chat-widget-tool chat-widget-tool--${e.status}`,t.setAttribute("data-tool-id",e.id);let n=this.getToolStatusIcon(e.status);return t.innerHTML=`
      <div class="chat-widget-tool__header">
        <span class="chat-widget-tool__icon">${n}</span>
        <span class="chat-widget-tool__name">${w(e.toolName)}</span>
        <span class="chat-widget-tool__status">${e.status}</span>
      </div>
    `,t}getToolStatusIcon(e){switch(e){case"pending":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chat-widget-tool__spinner">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 6v6l4 2"></path>
        </svg>`;case"complete":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;case"error":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>`;default:return""}}formatTime(e){return new Date(e).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}getElement(){return this.element}getMessage(){return this.message}updateContent(e,t=!1){this.message.content=e,fe(this.element,e),this.message.role==="user"?this.contentElement.innerHTML=this.markdownService.renderUserMessage(e):(this.contentElement.innerHTML=this.markdownService.renderProgressive(e,t),be(this.contentElement))}setStatus(e){this.message.status=e,this.element.setAttribute("data-status",e),e==="streaming"?this.element.classList.add("chat-widget-message--streaming"):this.element.classList.remove("chat-widget-message--streaming"),e==="error"?this.element.classList.add("chat-widget-message--error"):this.element.classList.remove("chat-widget-message--error")}addToolCall(e){this.message.toolCalls||(this.message.toolCalls=[]),this.message.toolCalls.push(e);let t=this.element.querySelector(".chat-widget-message__tools");t||(t=document.createElement("div"),t.className="chat-widget-message__tools",this.element.querySelector(".chat-widget-message__body")?.appendChild(t));let n=this.renderToolCall(e);n&&t.appendChild(n)}updateToolCall(e,t){let n=this.message.toolCalls?.find(s=>s.id===e);if(n){Object.assign(n,t);let s=this.element.querySelector(`[data-tool-id="${e}"]`);if(s&&t.status){s.className=`chat-widget-tool chat-widget-tool--${t.status}`;let r=s.querySelector(".chat-widget-tool__status");r&&(r.textContent=t.status);let a=s.querySelector(".chat-widget-tool__icon");a&&(a.innerHTML=this.getToolStatusIcon(t.status))}}}showError(e){this.setStatus("error");let t=document.createElement("div");t.className="chat-widget-message__error",t.innerHTML=`
      <span class="chat-widget-message__error-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </span>
      <span class="chat-widget-message__error-text">${w(e)}</span>
    `,this.element.querySelector(".chat-widget-message__body")?.appendChild(t)}scrollIntoView(){this.element.scrollIntoView({behavior:"smooth",block:"end"})}destroy(){this.element.remove()}};var jt=`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <line x1="22" y1="2" x2="11" y2="13"></line>
  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
</svg>
`,ee=class{constructor(e){this.isDisabled=!1;this.options=e,this.element=this.render(),this.textarea=this.element.querySelector(".chat-widget-input__field"),this.sendButton=this.element.querySelector(".chat-widget-input__send"),this.typingIndicator=this.element.querySelector(".chat-widget-typing"),this.setupEventListeners()}render(){let e=document.createElement("form");return e.className="chat-widget-input",e.setAttribute("autocomplete","off"),e.innerHTML=`
      <div class="chat-widget-typing" aria-live="polite" aria-hidden="true">
        <span class="chat-widget-typing__dot"></span>
        <span class="chat-widget-typing__dot"></span>
        <span class="chat-widget-typing__dot"></span>
        <span class="chat-widget-typing__text">AI is thinking...</span>
      </div>
      <div class="chat-widget-input__row">
        <textarea
          class="chat-widget-input__field"
          placeholder="${this.escapeAttr(this.options.placeholder)}"
          rows="1"
          aria-label="${this.escapeAttr(this.options.placeholder)}"
        ></textarea>
        <button
          type="submit"
          class="chat-widget-input__send"
          aria-label="Send message"
          title="Send message"
        >
          ${jt}
        </button>
      </div>
    `,e}setupEventListeners(){this.element.addEventListener("submit",e=>{e.preventDefault(),this.handleSubmit()}),this.textarea.addEventListener("input",()=>{this.autoResize(),this.updateSendButtonState()}),this.textarea.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.handleSubmit())}),this.textarea.addEventListener("paste",()=>{setTimeout(()=>{this.autoResize(),this.updateSendButtonState()},0)})}handleSubmit(){let e=this.textarea.value.trim();e&&!this.isDisabled&&(this.options.onSend(e),this.clear())}autoResize(){this.textarea.style.height="auto";let e=120,t=Math.min(this.textarea.scrollHeight,e);this.textarea.style.height=`${t}px`,this.textarea.style.overflowY=this.textarea.scrollHeight>e?"auto":"hidden"}updateSendButtonState(){let e=this.textarea.value.trim().length>0;this.sendButton.disabled=!e||this.isDisabled}escapeAttr(e){return e.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}getElement(){return this.element}focus(){this.textarea.focus()}clear(){this.textarea.value="",this.textarea.style.height="auto",this.updateSendButtonState()}setValue(e){this.textarea.value=e,this.autoResize(),this.updateSendButtonState()}getValue(){return this.textarea.value}disable(){this.isDisabled=!0,this.textarea.disabled=!0,this.sendButton.disabled=!0,this.element.classList.add("chat-widget-input--disabled")}enable(){this.isDisabled=!1,this.textarea.disabled=!1,this.updateSendButtonState(),this.element.classList.remove("chat-widget-input--disabled")}showTyping(){this.typingIndicator.classList.add("chat-widget-typing--visible"),this.typingIndicator.setAttribute("aria-hidden","false")}hideTyping(){this.typingIndicator.classList.remove("chat-widget-typing--visible"),this.typingIndicator.setAttribute("aria-hidden","true")}isInputDisabled(){return this.isDisabled}setPlaceholder(e){this.textarea.placeholder=e,this.textarea.setAttribute("aria-label",e)}destroy(){this.element.remove()}};function Ft(i){return`
    --chat-widget-primary: ${i.primaryColor};
    --chat-widget-bg: #ffffff;
    --chat-widget-text: #1a1a1a;
    --chat-widget-text-secondary: #6b7280;
    --chat-widget-user-bubble: ${i.primaryColor};
    --chat-widget-user-text: #ffffff;
    --chat-widget-agent-bubble: #f3f4f6;
    --chat-widget-agent-text: #1a1a1a;
    --chat-widget-border: #e5e7eb;
    --chat-widget-shadow: rgba(0, 0, 0, 0.15);
    --chat-widget-code-bg: #1e293b;
    --chat-widget-code-text: #e2e8f0;
    --chat-widget-radius: 12px;
    --chat-widget-avatar-size: ${i.avatarSize}px;
    --chat-widget-panel-width: ${i.chatWidth}px;
  `}var Ut=`
  /* ============================================
     Shadow DOM Reset and Container
     ============================================
     All styles are scoped to .chat-widget-root which lives
     inside the Shadow DOM boundary. This provides complete
     isolation from host page CSS.
     ============================================ */

  /* Apply to all elements within shadow DOM */
  :host {
    all: initial;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  .chat-widget-root {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                 'Noto Sans', 'Helvetica Neue', Arial, sans-serif,
                 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji';
    font-size: 14px;
    line-height: 1.5;
    color: var(--chat-widget-text, #1a1a1a);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .chat-widget-root > * {
    pointer-events: auto;
  }

  /* Screen reader only */
  .chat-widget-sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ============================================
     Avatar Button
     ============================================ */
  .chat-widget-avatar {
    position: fixed;
    width: var(--chat-widget-avatar-size, 60px);
    height: var(--chat-widget-avatar-size, 60px);
    border-radius: 50%;
    border: none;
    background: var(--chat-widget-primary, #0066cc);
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 20px var(--chat-widget-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99998;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .chat-widget-avatar--bottom-right {
    bottom: 20px;
    right: 20px;
  }

  .chat-widget-avatar--bottom-left {
    bottom: 20px;
    left: 20px;
  }

  .chat-widget-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 25px var(--chat-widget-shadow);
  }

  .chat-widget-avatar:focus {
    outline: 2px solid var(--chat-widget-primary);
    outline-offset: 3px;
  }

  .chat-widget-avatar:focus:not(:focus-visible) {
    outline: none;
  }

  .chat-widget-avatar--animated.chat-widget-avatar--pulse {
    animation: chat-widget-pulse 2s infinite;
  }

  @keyframes chat-widget-pulse {
    0%, 100% {
      box-shadow: 0 4px 20px var(--chat-widget-shadow);
    }
    50% {
      box-shadow: 0 4px 30px var(--chat-widget-primary);
    }
  }

  .chat-widget-avatar__image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .chat-widget-avatar__icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-widget-avatar__badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background: #ef4444;
    color: white;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ============================================
     Panel
     ============================================ */
  .chat-widget-panel {
    position: fixed;
    top: 0;
    bottom: 0;
    width: var(--chat-widget-panel-width, 400px);
    max-width: 100vw;
    background: var(--chat-widget-bg);
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 30px var(--chat-widget-shadow);
    z-index: 99999;
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
  }

  .chat-widget-panel--bottom-right {
    right: 0;
    transform: translateX(100%);
    box-shadow: -4px 0 30px var(--chat-widget-shadow);
  }

  .chat-widget-panel--bottom-left {
    left: 0;
    transform: translateX(-100%);
    box-shadow: 4px 0 30px var(--chat-widget-shadow);
  }

  .chat-widget-panel--open {
    transform: translateX(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .chat-widget-panel {
      transition: none;
    }
    .chat-widget-avatar--animated.chat-widget-avatar--pulse {
      animation: none;
    }
  }

  /* Mobile: full screen */
  @media (max-width: 768px) {
    .chat-widget-panel {
      width: 100%;
      max-width: 100%;
    }
  }

  /* ============================================
     Panel Header
     ============================================ */
  .chat-widget-panel__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--chat-widget-primary);
    color: white;
    flex-shrink: 0;
  }

  .chat-widget-panel__title h2 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .chat-widget-panel__actions {
    display: flex;
    gap: 8px;
  }

  .chat-widget-panel__btn {
    background: transparent;
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  .chat-widget-panel__btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .chat-widget-panel__btn:focus {
    outline: 2px solid white;
    outline-offset: 2px;
  }

  .chat-widget-panel__btn:focus:not(:focus-visible) {
    outline: none;
  }

  /* ============================================
     Messages Area
     ============================================ */
  .chat-widget-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .chat-widget-welcome {
    text-align: center;
    padding: 24px 16px;
    color: var(--chat-widget-text-secondary);
  }

  .chat-widget-welcome p {
    font-size: 15px;
    line-height: 1.5;
  }

  /* ============================================
     Message
     ============================================ */
  .chat-widget-message {
    display: flex;
    gap: 12px;
    max-width: 85%;
    animation: chat-widget-message-in 0.2s ease-out;
  }

  @keyframes chat-widget-message-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .chat-widget-message {
      animation: none;
    }
  }

  .chat-widget-message--user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .chat-widget-message--assistant {
    align-self: flex-start;
  }

  .chat-widget-message__avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--chat-widget-primary);
    flex-shrink: 0;
  }

  .chat-widget-message__body {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }

  .chat-widget-message__content {
    padding: 12px 16px;
    border-radius: var(--chat-widget-radius);
    line-height: 1.5;
    font-size: 15px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .chat-widget-message--user .chat-widget-message__content {
    background: var(--chat-widget-user-bubble);
    color: var(--chat-widget-user-text);
    border-bottom-right-radius: 4px;
  }

  .chat-widget-message--assistant .chat-widget-message__content {
    background: var(--chat-widget-agent-bubble);
    color: var(--chat-widget-agent-text);
    border-bottom-left-radius: 4px;
  }

  .chat-widget-message__meta {
    font-size: 11px;
    color: var(--chat-widget-text-secondary);
    padding: 0 4px;
  }

  /* Streaming cursor */
  .chat-widget-message--streaming .chat-widget-message__content::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 16px;
    background: var(--chat-widget-primary);
    animation: chat-widget-blink 1s infinite;
    margin-left: 4px;
    vertical-align: middle;
  }

  @keyframes chat-widget-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* Error state */
  .chat-widget-message--error .chat-widget-message__content {
    background: #fef2f2;
    color: #991b1b;
  }

  .chat-widget-message__error {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #fef2f2;
    border-radius: 8px;
    color: #991b1b;
    font-size: 13px;
    margin-top: 8px;
  }

  /* ============================================
     Tool Calls
     ============================================ */
  .chat-widget-message__tools {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .chat-widget-tool {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #fef3c7;
    border-radius: 8px;
    font-size: 13px;
  }

  .chat-widget-tool--complete {
    background: #d1fae5;
  }

  .chat-widget-tool--error {
    background: #fee2e2;
  }

  .chat-widget-tool__header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-widget-tool__name {
    font-weight: 500;
  }

  .chat-widget-tool__status {
    font-size: 11px;
    color: var(--chat-widget-text-secondary);
    text-transform: capitalize;
  }

  .chat-widget-tool__spinner {
    animation: chat-widget-spin 1s linear infinite;
  }

  @keyframes chat-widget-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ============================================
     Input Area
     ============================================ */
  .chat-widget-input {
    padding: 16px 20px;
    border-top: 1px solid var(--chat-widget-border);
    background: var(--chat-widget-bg);
    flex-shrink: 0;
  }

  .chat-widget-input__row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .chat-widget-input__field {
    flex: 1;
    border: 1px solid var(--chat-widget-border);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 15px;
    resize: none;
    line-height: 1.4;
    max-height: 120px;
    overflow-y: hidden;
    font-family: inherit;
    background: var(--chat-widget-bg);
    color: var(--chat-widget-text);
  }

  .chat-widget-input__field:focus {
    outline: none;
    border-color: var(--chat-widget-primary);
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .chat-widget-input__field::placeholder {
    color: var(--chat-widget-text-secondary);
  }

  .chat-widget-input__send {
    width: 44px;
    height: 44px;
    min-width: 44px;
    border: none;
    border-radius: 50%;
    background: var(--chat-widget-primary);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease, opacity 0.2s ease;
    flex-shrink: 0;
  }

  .chat-widget-input__send:hover:not(:disabled) {
    filter: brightness(0.9);
  }

  .chat-widget-input__send:focus {
    outline: 2px solid var(--chat-widget-primary);
    outline-offset: 2px;
  }

  .chat-widget-input__send:focus:not(:focus-visible) {
    outline: none;
  }

  .chat-widget-input__send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .chat-widget-input--disabled .chat-widget-input__field {
    background: #f9fafb;
    cursor: not-allowed;
  }

  /* ============================================
     Typing Indicator
     ============================================ */
  .chat-widget-typing {
    display: none;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    color: var(--chat-widget-text-secondary);
    font-size: 13px;
  }

  .chat-widget-typing--visible {
    display: flex;
  }

  .chat-widget-typing__dot {
    width: 6px;
    height: 6px;
    background: var(--chat-widget-primary);
    border-radius: 50%;
    animation: chat-widget-bounce 1.4s infinite ease-in-out;
  }

  .chat-widget-typing__dot:nth-child(1) { animation-delay: 0s; }
  .chat-widget-typing__dot:nth-child(2) { animation-delay: 0.2s; }
  .chat-widget-typing__dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes chat-widget-bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }

  /* ============================================
     Markdown Styles
     ============================================
     Markdown renders inline within the message bubble.
     No card or container styling - just formatted text.
     ============================================ */
  .chat-widget-markdown {
    line-height: 1.6;
  }

  .chat-widget-markdown > :first-child {
    margin-top: 0;
  }

  .chat-widget-markdown > :last-child {
    margin-bottom: 0;
  }

  .chat-widget-markdown p {
    margin: 0 0 8px;
  }

  .chat-widget-markdown p:last-child {
    margin-bottom: 0;
  }

  .chat-widget-markdown h1,
  .chat-widget-markdown h2,
  .chat-widget-markdown h3,
  .chat-widget-markdown h4,
  .chat-widget-markdown h5,
  .chat-widget-markdown h6 {
    margin: 16px 0 8px;
    font-weight: 600;
    line-height: 1.3;
  }

  .chat-widget-markdown h1 { font-size: 1.5em; }
  .chat-widget-markdown h2 { font-size: 1.3em; }
  .chat-widget-markdown h3 { font-size: 1.15em; }
  .chat-widget-markdown h4,
  .chat-widget-markdown h5,
  .chat-widget-markdown h6 { font-size: 1em; }

  .chat-widget-markdown ul,
  .chat-widget-markdown ol {
    margin: 8px 0;
    padding-left: 24px;
  }

  .chat-widget-markdown li {
    margin: 4px 0;
  }

  .chat-widget-markdown blockquote {
    margin: 12px 0;
    padding: 8px 16px;
    border-left: 4px solid var(--chat-widget-primary);
    background: rgba(0, 0, 0, 0.03);
    border-radius: 0 8px 8px 0;
  }

  .chat-widget-markdown hr {
    border: none;
    border-top: 1px solid var(--chat-widget-border);
    margin: 16px 0;
  }

  .chat-widget-markdown a {
    color: var(--chat-widget-primary);
    text-decoration: underline;
  }

  .chat-widget-markdown a:hover {
    text-decoration: none;
  }

  .chat-widget-markdown table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    font-size: 14px;
  }

  .chat-widget-markdown th,
  .chat-widget-markdown td {
    border: 1px solid var(--chat-widget-border);
    padding: 8px 12px;
    text-align: left;
  }

  .chat-widget-markdown th {
    background: rgba(0, 0, 0, 0.03);
    font-weight: 600;
  }

  .chat-widget-markdown img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 8px 0;
  }

  /* Inline code */
  .chat-widget-inline-code {
    background: rgba(0, 0, 0, 0.06);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    font-size: 0.9em;
  }

  /* Code blocks */
  .chat-widget-code-block {
    margin: 12px 0;
    border-radius: 8px;
    overflow: hidden;
    background: var(--chat-widget-code-bg);
  }

  .chat-widget-code-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .chat-widget-code-lang {
    font-size: 12px;
    color: var(--chat-widget-code-text);
    opacity: 0.7;
    text-transform: uppercase;
  }

  .chat-widget-code-copy {
    background: transparent;
    border: none;
    color: var(--chat-widget-code-text);
    opacity: 0.7;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: opacity 0.2s ease, background 0.2s ease;
  }

  .chat-widget-code-copy:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.1);
  }

  .chat-widget-code-copy--success {
    color: #10b981;
    opacity: 1;
  }

  .chat-widget-code-block pre {
    margin: 0;
    padding: 12px;
    overflow-x: auto;
  }

  .chat-widget-code-block code {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    font-size: 13px;
    line-height: 1.5;
    color: var(--chat-widget-code-text);
  }

  /* Syntax highlighting */
  .chat-widget-hl-keyword { color: #c678dd; }
  .chat-widget-hl-string { color: #98c379; }
  .chat-widget-hl-number { color: #d19a66; }
  .chat-widget-hl-comment { color: #5c6370; font-style: italic; }
  .chat-widget-hl-type { color: #e5c07b; }
  .chat-widget-hl-builtin { color: #61afef; }

  /* Task lists */
  .chat-widget-task-item {
    list-style: none;
    margin-left: -20px;
  }

  .chat-widget-checkbox {
    margin-right: 8px;
    font-size: 1.1em;
  }

  .chat-widget-checkbox--checked {
    color: var(--chat-widget-primary);
  }

  /* Plain text */
  .chat-widget-plaintext {
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* ============================================
     Panel Error
     ============================================ */
  .chat-widget-panel__error {
    padding: 12px 20px;
    background: #fef2f2;
    border-bottom: 1px solid #fecaca;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .chat-widget-panel__error p {
    color: #991b1b;
    font-size: 14px;
    margin: 0;
  }

  .chat-widget-panel__error-dismiss {
    background: transparent;
    border: 1px solid #fca5a5;
    color: #991b1b;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }

  .chat-widget-panel__error-dismiss:hover {
    background: #fee2e2;
  }
`;function Ue(i){return`
    .chat-widget-root {
      ${Ft(i)}
    }
    ${Ut}
  `}var P=class{constructor(e){this.container=null;this.avatar=null;this.panel=null;this.input=null;this.messageComponents=new Map;this.isOpen=!1;this.isStreaming=!1;this.currentStreamingMessage=null;let t=D(e);if(t.length>0)throw console.error("[ChatWidget] Configuration errors:",t),new Error(`ChatWidget configuration invalid: ${t.join(", ")}`);this.config=B(e),this.apiService=new O(this.config),this.markdownService=new V(this.config),this.sessionService=new Q(this.config),this.pageContextService=new X(this.config)}init(){this.container=Oe(),Ne(Ue(this.config));let e=this.sessionService.initialize();this.avatar=new K({imageUrl:this.config.avatarImage,size:this.config.avatarSize,position:this.config.position,primaryColor:this.config.primaryColor,onClick:()=>this.toggle()}),this.panel=new Y({title:this.config.headerTitle,width:this.config.chatWidth,height:this.config.chatHeight,position:this.config.position,primaryColor:this.config.primaryColor,pushContent:this.config.pushContent,onClose:()=>this.close(),onMinimize:()=>this.close(),onClearHistory:()=>this.clearHistory()}),this.input=new ee({placeholder:this.config.placeholder,primaryColor:this.config.primaryColor,onSend:t=>this.sendMessage(t)}),this.container.appendChild(this.avatar.getElement()),this.container.appendChild(this.panel.getElement()),this.panel.mountInput(this.input),this.config.welcomeMessage&&this.panel.setWelcomeMessage(this.config.welcomeMessage),e.messages.forEach(t=>this.renderMessage(t)),this.config.openOnLoad&&this.open(),this.exposePublicAPI(),console.log("[ChatWidget] Initialized successfully")}open(){this.isOpen||!this.panel||!this.avatar||(this.isOpen=!0,this.avatar.hide(),this.avatar.setOpen(!0),this.panel.open(),setTimeout(()=>{this.input?.focus()},300),this.config.onOpen?.(),G("Chat opened"))}close(){!this.isOpen||!this.panel||!this.avatar||(this.isOpen=!1,this.panel.close(),this.avatar.show(),this.avatar.setOpen(!1),this.config.onClose?.(),G("Chat closed"))}toggle(){this.isOpen?this.close():this.open()}async sendMessage(e){if(this.isStreaming||!e.trim())return;let t=this.sessionService.createUserMessage(e);this.sessionService.addMessage(t),this.renderMessage(t),this.config.onMessageSent?.(t);let n=this.sessionService.createAssistantMessage();this.sessionService.addMessage(n),this.renderMessage(n),this.currentStreamingMessage=n,this.isStreaming=!0,this.input?.disable(),this.input?.showTyping();let s=this.pageContextService.extractContext();try{await this.apiService.streamMessage(e,this.sessionService.getConversationId(),r=>this.handleSSEEvent(r),()=>this.handleStreamComplete(),r=>this.handleStreamError(r),s)}catch(r){this.handleStreamError(r)}}handleSSEEvent(e){if(!this.currentStreamingMessage)return;let t=this.messageComponents.get(this.currentStreamingMessage.id);if(t)switch(e.type){case"start":break;case"text":{let n=e,s=this.currentStreamingMessage.content+(n.content||"");this.currentStreamingMessage.content=s,t.updateContent(s,!1),this.panel?.scrollToBottom();break}case"tool-call":{let n=e,s={id:n.content?.toolCallId||_(),toolName:n.content?.toolName||"unknown",args:n.content?.args,status:"pending"};t.addToolCall(s);break}case"tool-result":{let n=e;n.content?.toolCallId&&t.updateToolCall(n.content.toolCallId,{result:n.content.result,status:"complete"});break}case"error":{this.currentStreamingMessage.status="error",t.setStatus("error");let n=e.content?.message||"An error occurred";t.showError(n);break}case"done":case"finish":break}}handleStreamComplete(){if(this.currentStreamingMessage){this.currentStreamingMessage.status="complete";let e=this.messageComponents.get(this.currentStreamingMessage.id);e&&(e.updateContent(this.currentStreamingMessage.content,!0),e.setStatus("complete")),this.sessionService.updateMessage(this.currentStreamingMessage.id,{content:this.currentStreamingMessage.content,status:"complete"}),this.config.onMessageReceived?.(this.currentStreamingMessage),G("New message received")}this.cleanupStreaming()}handleStreamError(e){if(console.error("[ChatWidget] Stream error:",e),this.currentStreamingMessage){this.currentStreamingMessage.status="error",this.currentStreamingMessage.content="Sorry, something went wrong. Please try again.";let t=this.messageComponents.get(this.currentStreamingMessage.id);t&&(t.updateContent(this.currentStreamingMessage.content,!0),t.setStatus("error")),this.sessionService.updateMessage(this.currentStreamingMessage.id,{content:this.currentStreamingMessage.content,status:"error"})}this.config.onError?.(e),this.cleanupStreaming()}cleanupStreaming(){this.isStreaming=!1,this.currentStreamingMessage=null,this.input?.hideTyping(),this.input?.enable(),this.input?.focus()}renderMessage(e){let t=new J(e,this.markdownService);this.messageComponents.set(e.id,t),this.panel?.addMessage(t.getElement())}clearHistory(){this.sessionService.clear(),this.messageComponents.clear(),this.panel?.clearMessages(),this.config.welcomeMessage&&this.panel?.setWelcomeMessage(this.config.welcomeMessage)}destroy(){this.apiService.abort(),this.isOpen&&this.close(),this.avatar?.destroy(),this.panel?.destroy(),this.input?.destroy(),this.messageComponents.clear(),qe(),typeof window<"u"&&delete window.ChatWidget,console.log("[ChatWidget] Destroyed")}exposePublicAPI(){typeof window<"u"&&(window.ChatWidget={open:()=>this.open(),close:()=>this.close(),toggle:()=>this.toggle(),sendMessage:e=>this.sendMessage(e),clearHistory:()=>this.clearHistory(),destroy:()=>this.destroy()})}};if(typeof window<"u"){window.ChatWidget=P;let i=()=>{if(window.ChatWidgetConfig)try{new P(window.ChatWidgetConfig).init()}catch(e){console.error("[ChatWidget] Auto-initialization failed:",e)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",i):setTimeout(i,0)}return Ye(Zt);})();
